.\\" auto-generated by docbook2man-spec $Revision: 1.1.1.1 $
.TH "PG_RESTORE" "1" "2009-06-27" "Application" "PostgreSQL Client Applications"
.SH NAME
pg_restore \- restore a PostgreSQL database from an   archive file created by pg_dump

.SH SYNOPSIS
.sp
\fBpg_restore\fR [ \fB\fIoption\fB\fR\fI...\fR ]  [ \fB\fIfilename\fB\fR ] 
.SH "DESCRIPTION"
.PP
\fBpg_restore\fR is a utility for restoring a
PostgreSQL database from an archive
created by \fBpg_dump\fR(1) in one of the non-plain-text
formats. It will issue the commands necessary to reconstruct the
database to the state it was in at the time it was saved. The
archive files also allow \fBpg_restore\fR to
be selective about what is restored, or even to reorder the items
prior to being restored. The archive files are designed to be
portable across architectures.
.PP
\fBpg_restore\fR can operate in two modes.
If a database name is specified, the archive is restored directly into
the database. Otherwise, a script containing the SQL
commands necessary to rebuild the database is created and written
to a file or standard output. The script output is equivalent to
the plain text output format of \fBpg_dump\fR.
Some of the options controlling the output are therefore analogous to
\fBpg_dump\fR options.
.PP
Obviously, \fBpg_restore\fR cannot restore information
that is not present in the archive file. For instance, if the
archive was made using the ``dump data as
\fBINSERT\fR commands'' option,
\fBpg_restore\fR will not be able to load the data
using \fBCOPY\fR statements.
.SH "OPTIONS"
.PP
\fBpg_restore\fR accepts the following command
line arguments.
.TP
\fB\fIfilename\fB\fR
Specifies the location of the archive file to be restored.
If not specified, the standard input is used.
.TP
\fB-a\fR
.TP
\fB--data-only\fR
Restore only the data, not the schema (data definitions).
.TP
\fB-c\fR
.TP
\fB--clean\fR
Clean (drop) database objects before recreating them.
.TP
\fB-C\fR
.TP
\fB--create\fR
Create the database before restoring into it. (When this
option is used, the database named with \fB-d\fR is
used only to issue the initial \fBCREATE DATABASE\fR
command. All data is restored into the database name that
appears in the archive.)
.TP
\fB-d \fIdbname\fB\fR
.TP
\fB--dbname=\fIdbname\fB\fR
Connect to database \fIdbname\fR and restore directly
into the database.
.TP
\fB-e\fR
.TP
\fB--exit-on-error\fR
Exit if an error is encountered while sending SQL commands to
the database. The default is to continue and to display a count of
errors at the end of the restoration.
.TP
\fB-f \fIfilename\fB\fR
.TP
\fB--file=\fIfilename\fB\fR
Specify output file for generated script, or for the listing
when used with \fB-l\fR. Default is the standard
output.
.TP
\fB-F \fIformat\fB\fR
.TP
\fB--format=\fIformat\fB\fR
Specify format of the archive. It is not necessary to specify
the format, since \fBpg_restore\fR will
determine the format automatically. If specified, it can be
one of the following:
.RS
.TP
\fBt\fR
.TP
\fBtar\fR
The archive is a \fBtar\fR archive. Using this
archive format allows reordering and/or exclusion of schema
elements at the time the database is restored. It is also
possible to limit which data is reloaded at restore time.
.TP
\fBc\fR
.TP
\fBcustom\fR
The archive is in the custom format of
\fBpg_dump\fR. This is the most
flexible format in that it allows reordering of data load
as well as schema elements. This format is also compressed
by default.
.RE
.PP
.TP
\fB-i\fR
.TP
\fB--ignore-version\fR
A deprecated option that is now ignored.
.TP
\fB-I \fIindex\fB\fR
.TP
\fB--index=\fIindex\fB\fR
Restore definition of named index only.
.TP
\fB-j \fInumber-of-jobs\fB\fR
.TP
\fB--jobs=\fInumber-of-jobs\fB\fR
Run the most time-consuming parts
of \fBpg_restore\fR \(em those which load data,
create indexes, or create constraints \(em using multiple
concurrent jobs. This option can dramatically reduce the time
to restore a large database to a server running on a
multi-processor machine.

Each job is one process or one thread, depending on the
operating system, and uses a separate connection to the
server.

The optimal value for this option depends on the hardware
setup of the server, of the client, and of the network.
Factors include the number of CPU cores and the disk setup. A
good place to start is the number of CPU cores on the server,
but values larger than that can also lead to faster restore
times in many cases. Of course, values that are too high will
lead to decreasing performance because of thrashing.

Only the custom archive format is supported with this option.
The input file must be a regular file (not, for example, a
pipe). This option is ignored when emitting a script rather
than connecting directly to a database server. Also, multiple
jobs cannot be used together with the
option \fB--single-transaction\fR.
.TP
\fB-l\fR
.TP
\fB--list\fR
List the contents of the archive. The output of this operation
can be used with the \fB-L\fR option to restrict
and reorder the items that are restored.
.TP
\fB-L \fIlist-file\fB\fR
.TP
\fB--use-list=\fIlist-file\fB\fR
Restore elements in \fI list-file\fR only, and in the
order they appear in the file. Lines can be moved and can also
be commented out by placing a ; at the
start of the line. (See below for examples.)
.TP
\fB-n \fInamespace\fB\fR
.TP
\fB--schema=\fIschema\fB\fR
Restore only objects that are in the named schema. This can be
combined with the \fB-t\fR option to restore just a
specific table.
.TP
\fB-O\fR
.TP
\fB--no-owner\fR
Do not output commands to set
ownership of objects to match the original database.
By default, \fBpg_restore\fR issues
\fBALTER OWNER\fR or
\fBSET SESSION AUTHORIZATION\fR
statements to set ownership of created schema elements.
These statements will fail unless the initial connection to the
database is made by a superuser
(or the same user that owns all of the objects in the script).
With \fB-O\fR, any user name can be used for the
initial connection, and this user will own all the created objects.
.TP
\fB--no-tablespaces\fR
Do not output commands to select tablespaces.
With this option, all objects will be created in whichever
tablespace is the default during restore.
.TP
\fB-P \fIfunction-name(argtype [, ...])\fB\fR
.TP
\fB--function=\fIfunction-name(argtype [, ...])\fB\fR
Restore the named function only. Be careful to spell the function
name and arguments exactly as they appear in the dump file's table
of contents.
.TP
\fB-R\fR
.TP
\fB--no-reconnect\fR
This option is obsolete but still accepted for backwards
compatibility.
.TP
\fB-s\fR
.TP
\fB--schema-only\fR
Restore only the schema (data definitions), not the data (table
contents). Sequence current values will not be restored, either.
(Do not confuse this with the \fB--schema\fR option, which
uses the word ``schema'' in a different meaning.)
.TP
\fB-S \fIusername\fB\fR
.TP
\fB--superuser=\fIusername\fB\fR
Specify the superuser user name to use when disabling triggers.
This is only relevant if \fB--disable-triggers\fR is used.
.TP
\fB-t \fItable\fB\fR
.TP
\fB--table=\fItable\fB\fR
Restore definition and/or data of named table only.
.TP
\fB-T \fItrigger\fB\fR
.TP
\fB--trigger=\fItrigger\fB\fR
Restore named trigger only.
.TP
\fB-v\fR
.TP
\fB--verbose\fR
Specifies verbose mode.
.TP
\fB-x\fR
.TP
\fB--no-privileges\fR
.TP
\fB--no-acl\fR
Prevent restoration of access privileges (grant/revoke commands).
.TP
\fB--disable-triggers\fR
This option is only relevant when performing a data-only restore.
It instructs \fBpg_restore\fR to execute commands
to temporarily disable triggers on the target tables while
the data is reloaded. Use this if you have referential
integrity checks or other triggers on the tables that you
do not want to invoke during data reload.

Presently, the commands emitted for
\fB--disable-triggers\fR must be done as superuser. So, you
should also specify a superuser name with \fB-S\fR, or
preferably run \fBpg_restore\fR as a
PostgreSQL superuser.
.TP
\fB--use-set-session-authorization\fR
Output SQL-standard \fBSET SESSION AUTHORIZATION\fR commands
instead of \fBALTER OWNER\fR commands to determine object
ownership. This makes the dump more standards compatible, but
depending on the history of the objects in the dump, might not restore
properly.
.TP
\fB--no-data-for-failed-tables\fR
By default, table data is restored even if the creation command
for the table failed (e.g., because it already exists).
With this option, data for such a table is skipped.
This behavior is useful if the target database already
contains the desired table contents. For example,
auxiliary tables for PostgreSQL extensions
such as PostGIS might already be loaded in
the target database; specifying this option prevents duplicate
or obsolete data from being loaded into them.

This option is effective only when restoring directly into a
database, not when producing SQL script output.
.TP
\fB-1\fR
.TP
\fB--single-transaction\fR
Execute the restore as a single transaction (that is, wrap the
emitted commands in \fBBEGIN\fR/\fBCOMMIT\fR). This
ensures that either all the commands complete successfully, or no
changes are applied. This option implies
\fB--exit-on-error\fR.
.PP
.PP
\fBpg_restore\fR also accepts
the following command line arguments for connection parameters:
.TP
\fB-h \fIhost\fB\fR
.TP
\fB--host=\fIhost\fB\fR
Specifies the host name of the machine on which the server is
running. If the value begins with a slash, it is used as the
directory for the Unix domain socket. The default is taken
from the \fBPGHOST\fR environment variable, if set,
else a Unix domain socket connection is attempted.
.TP
\fB-p \fIport\fB\fR
.TP
\fB--port=\fIport\fB\fR
Specifies the TCP port or local Unix domain socket file
extension on which the server is listening for connections.
Defaults to the \fBPGPORT\fR environment variable, if
set, or a compiled-in default.
.TP
\fB-U \fIusername\fB\fR
.TP
\fB--username=\fIusername\fB\fR
User name to connect as.
.TP
\fB-w\fR
.TP
\fB--no-password\fR
Never issue a password prompt. If the server requires
password authentication and a password is not available by
other means such as a \fI.pgpass\fR file, the
connection attempt will fail. This option can be useful in
batch jobs and scripts where no user is present to enter a
password.
.TP
\fB-W\fR
.TP
\fB--password\fR
Force \fBpg_restore\fR to prompt for a
password before connecting to a database.

This option is never essential, since
\fBpg_restore\fR will automatically prompt
for a password if the server demands password authentication.
However, \fBpg_restore\fR will waste a
connection attempt finding out that the server wants a password.
In some cases it is worth typing \fB-W\fR to avoid the extra
connection attempt.
.TP
\fB--role=\fIrolename\fB\fR
Specifies a role name to be used to perform the restore.
This option causes \fBpg_restore\fR to issue a
\fBSET ROLE\fR \fIrolename\fR
command after connecting to the database. It is useful when the
authenticated user (specified by \fB-U\fR) lacks privileges
needed by \fBpg_restore\fR, but can switch to a role with
the required rights. Some installations have a policy against
logging in directly as a superuser, and use of this option allows
restores to be performed without violating the policy.
.PP
.SH "ENVIRONMENT"
.TP
\fBPGHOST\fR
.TP
\fBPGOPTIONS\fR
.TP
\fBPGPORT\fR
.TP
\fBPGUSER\fR
Default connection parameters
.PP
This utility, like most other PostgreSQL utilities,
also uses the environment variables supported by \fBlibpq\fR
(see in the documentation).
.PP
.SH "DIAGNOSTICS"
.PP
When a direct database connection is specified using the
\fB-d\fR option, \fBpg_restore\fR
internally executes SQL statements. If you have
problems running \fBpg_restore\fR, make sure
you are able to select information from the database using, for
example, \fBpsql\fR(1). Also, any default connection
settings and environment variables used by the
\fBlibpq\fR front-end library will apply.
.SH "NOTES"
.PP
If your installation has any local additions to the
template1 database, be careful to load the output of
\fBpg_restore\fR into a truly empty database;
otherwise you are likely to get errors due to duplicate definitions
of the added objects. To make an empty database without any local
additions, copy from template0 not template1, for example:
.sp
.nf
CREATE DATABASE foo WITH TEMPLATE template0;
.sp
.fi
.PP
The limitations of \fBpg_restore\fR are detailed below.
.TP 0.2i
\(bu
When restoring data to a pre-existing table and the option
\fB--disable-triggers\fR is used,
\fBpg_restore\fR emits commands
to disable triggers on user tables before inserting the data then emits commands to
re-enable them after the data has been inserted. If the restore is stopped in the
middle, the system catalogs might be left in the wrong state.
.TP 0.2i
\(bu
\fBpg_restore\fR cannot restore large objects
selectively, for instance only those for a specific table. If
an archive contains large objects, then all large objects will be
restored, or none of them if they are excluded via \fB-L\fR,
\fB-t\fR, or other options.
.PP
.PP
See also the \fBpg_dump\fR(1) documentation for details on
limitations of \fBpg_dump\fR.
.PP
Once restored, it is wise to run \fBANALYZE\fR on each
restored table so the optimizer has useful statistics.
.SH "EXAMPLES"
.PP
Assume we have dumped a database called mydb into a
custom-format dump file:
.sp
.nf
$ \fBpg_dump -Fc mydb > db.dump\fR
.sp
.fi
.PP
To drop the database and recreate it from the dump:
.sp
.nf
$ \fBdropdb mydb\fR
$ \fBpg_restore -C -d postgres db.dump\fR
.sp
.fi
The database named in the \fB-d\fR switch can be any database existing
in the cluster; \fBpg_restore\fR only uses it to issue the
\fBCREATE DATABASE\fR command for mydb. With
\fB-C\fR, data is always restored into the database name that appears
in the dump file.
.PP
To reload the dump into a new database called newdb:
.sp
.nf
$ \fBcreatedb -T template0 newdb\fR
$ \fBpg_restore -d newdb db.dump\fR
.sp
.fi
Notice we don't use \fB-C\fR, and instead connect directly to the
database to be restored into. Also note that we clone the new database
from template0 not template1, to ensure it is
initially empty.
.PP
To reorder database items, it is first necessary to dump the table of
contents of the archive:
.sp
.nf
$ \fBpg_restore -l db.dump > db.list\fR
.sp
.fi
The listing file consists of a header and one line for each item, e.g.:
.sp
.nf
;
; Archive created at Fri Jul 28 22:28:36 2000
;     dbname: mydb
;     TOC Entries: 74
;     Compression: 0
;     Dump Version: 1.4-0
;     Format: CUSTOM
;
;
; Selected TOC Entries:
;
2; 145344 TABLE species postgres
3; 145344 ACL species
4; 145359 TABLE nt_header postgres
5; 145359 ACL nt_header
6; 145402 TABLE species_records postgres
7; 145402 ACL species_records
8; 145416 TABLE ss_old postgres
9; 145416 ACL ss_old
10; 145433 TABLE map_resolutions postgres
11; 145433 ACL map_resolutions
12; 145443 TABLE hs_old postgres
13; 145443 ACL hs_old
.sp
.fi
Semicolons start a comment, and the numbers at the start of lines refer to the
internal archive ID assigned to each item.
.PP
Lines in the file can be commented out, deleted, and reordered. For example:
.sp
.nf
10; 145433 TABLE map_resolutions postgres
;2; 145344 TABLE species postgres
;4; 145359 TABLE nt_header postgres
6; 145402 TABLE species_records postgres
;8; 145416 TABLE ss_old postgres
.sp
.fi
could be used as input to \fBpg_restore\fR and would only restore
items 10 and 6, in that order:
.sp
.nf
$ \fBpg_restore -L db.list db.dump\fR
.sp
.fi
.SH "SEE ALSO"
\fBpg_dump\fR(1), \fBpg_dumpall\fR(1), \fBpsql\fR(1)
